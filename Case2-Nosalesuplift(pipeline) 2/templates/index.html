<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Samsung Worklet 8 - No sales prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-container { margin-top: 30px; margin-bottom: 30px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: rgba(255, 255, 255, 0.95); }
        .card-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 15px 15px 0 0 !important; padding: 20px; }
        .nav-pills .nav-link { color: #667eea; }
        .nav-pills .nav-link.active { background-color: #667eea; color: white; }
        .form-control, .form-select { border-radius: 10px; padding: 12px; }
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); border: none; border-radius: 25px; padding: 12px 30px; font-weight: 600; }
        .btn-secondary { border-radius: 25px; padding: 12px 30px; font-weight: 600; }
        .upload-area { border: 2px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; background: rgba(102, 126, 234, 0.05); cursor: pointer; }
        .results-card { margin-top: 20px; border-left: 4px solid #28a745; }
        .navbar-gradient { background: linear-gradient(45deg, #667eea, #764ba2); }
        .navbar-brand { color: #fff !important; font-weight: 700; }
    </style>
</head>
<body data-has-models="{{ 1 if available_models|length > 0 else 0 }}">
    <nav class="navbar navbar-expand-lg navbar-gradient">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-gauge-high me-2"></i>Samsung Worklet 8</a>
        </div>
    </nav>
    <div class="container main-container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header text-center">
                        <h1><i class="fas fa-chart-line me-2"></i>No sales prediction</h1>
                    </div>
                    <div class="card-body p-4">
                        {% if warning %}
                            <div class="alert alert-warning">{{ warning }}</div>
                        {% endif %}
                        <ul class="nav nav-pills nav-fill mb-4" id="predictionTabs">
                            <li class="nav-item">
                                <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-prediction" type="button" role="tab">
                                    <i class="fas fa-user me-2"></i>Single Prediction
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch-prediction" type="button" role="tab">
                                    <i class="fas fa-file-csv me-2"></i>Batch Prediction
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="single-prediction" role="tabpanel">
                                <form action="/predict" method="post">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="store" class="form-label">Store Number</label>
                                            <select class="form-select" id="store" name="store" required>
                                                {% for store_num in options.store_list %}
                                                    <option value="{{ store_num }}" {% if form_data.get('store') == store_num|string %}selected{% endif %}>{{ store_num }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="item" class="form-label">Item Number</label>
                                            <select class="form-select" id="item" name="item" required>
                                                 {% for item_num in options.item_list %}
                                                    <option value="{{ item_num }}" {% if form_data.get('item') == item_num|string %}selected{% endif %}>{{ item_num }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="month" class="form-label">Month</label>
                                            <select class="form-select" id="month" name="month" required>
                                                {% for i in range(1, 13) %}<option value="{{ i }}" {% if form_data.get('month') == i|string %}selected{% endif %}>{{ i }}</option>{% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="day" class="form-label">Day</label>
                                            <select class="form-select" id="day" name="day" required>
                                                {% for i in range(1, 32) %}<option value="{{ i }}" {% if form_data.get('day') == i|string %}selected{% endif %}>{{ i }}</option>{% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <hr class="my-4">
                                    <div class="mb-3">
                                        <label for="model_choice" class="form-label"><b>Choose Prediction Model</b></label>
                                        <select class="form-select" name="model_choice" id="model_choice">
                                            {% for key in available_models %}
                                                <option value="{{ key }}" {% if form_data.get('model_choice') == key %}selected{% endif %}>{{ key.replace('_',' ') | title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="text-center mt-3 d-grid gap-2 d-sm-flex justify-content-sm-center">
                                        <button type="submit" class="btn btn-primary btn-lg" {% if available_models|length == 0 %}disabled{% endif %}><i class="fas fa-brain me-2"></i>Predict Sales</button>
                                        <a href="/" class="btn btn-secondary btn-lg"><i class="fas fa-sync-alt me-2"></i>Reset</a>
                                    </div>
                                </form>
                            </div>

                            <div class="tab-pane fade" id="batch-prediction" role="tabpanel">
                                <form id="batchForm">
                                    <div class="upload-area" tabindex="0" role="button" aria-label="Upload CSV file"
                                         onclick="document.getElementById('fileInput').click();"
                                         onkeydown="if(event.key==='Enter'||event.key===' '){document.getElementById('fileInput').click();}">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <h4>Upload Test CSV File</h4>
                                        <p class="text-muted" id="fileName">Your test file must contain 'date', 'store', and 'item' columns.</p>
                                        <input type="file" id="fileInput" name="file" class="d-none" accept=".csv">
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="submit" class="btn btn-primary btn-lg" {% if available_models|length == 0 %}disabled{% endif %}><i class="fas fa-cogs me-2"></i>Process File</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div id="results-area" class="mt-4">
                             {% if prediction_text %}
                            <div class="card results-card">
                                <div class="card-body text-center">
                                    <h4 class="card-title">{{ prediction_text }}</h4>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Show selected filename for batch upload
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileName');
    if (fileInput && fileNameDisplay) {
        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            }
        };
    }

    // Handle batch form submission
    const batchForm = document.getElementById('batchForm');
    const resultsArea = document.getElementById('results-area');
    if (batchForm && resultsArea) {
        batchForm.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(batchForm);
            
            if (!fileInput || !fileInput.files[0]) {
                resultsArea.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> Please select a file to upload.</div>`;
                return;
            }

            resultsArea.innerHTML = `<div class="text-center p-3"><h4><i class="fas fa-spinner fa-spin me-2"></i>Processing...</h4></div>`;

            try {
                const response = await fetch('/batch_predict', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    resultsArea.innerHTML = `
                        <div class="card results-card">
                            <div class="card-body text-center">
                                <h4 class="card-title text-success"><i class="fas fa-check-circle me-2"></i>Success!</h4>
                                <p>${data.records_processed} records were processed.</p>
                                <a href="${data.download_url}" class="btn btn-success"><i class="fas fa-download me-2"></i>Download Predictions</a>
                            </div>
                        </div>`;
                } else {
                    resultsArea.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error}
                        </div>`;
                }
            } catch (err) {
                resultsArea.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${err}
                    </div>`;
            }
        };
    }

    // Disable submit buttons if no models are available using data attribute
    const hasModels = document.body.dataset.hasModels === '1';
    if (!hasModels) {
        const singleBtn = document.querySelector('#single-prediction button[type="submit"]');
        const batchBtn = document.querySelector('#batch-prediction button[type="submit"]');
        singleBtn?.setAttribute('disabled', 'disabled');
        batchBtn?.setAttribute('disabled', 'disabled');
    }
</script>
</body>
</html>